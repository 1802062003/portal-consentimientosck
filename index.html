<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portal de Firmas | Cl√≠nica</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="data.js"></script>

  <style>
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: #0b0f19; color: #e6e8ee; }
    header {
      padding: 18px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(255,255,255,0.02);
      backdrop-filter: blur(10px);
    }
    header h1 { margin: 0; font-size: 16px; }
    header .badge {
      padding: 8px 12px; border-radius: 999px; font-size: 12px;
      background: rgba(145, 255, 200, 0.10);
      border: 1px solid rgba(145, 255, 200, 0.25);
      color: #91ffc8;
    }
    main {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      padding: 18px;
      height: calc(100vh - 70px);
    }
    .panel {
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      background: rgba(255,255,255,0.03);
      overflow: hidden;
    }
    .doc-list { padding: 14px; }
    .doc-list h2 { margin: 0 0 10px; font-size: 14px; font-weight: 700; color: #cfd6e6; }
    .doc-item {
      padding: 12px; border-radius: 12px; margin-bottom: 10px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.02);
      transition: all .2s ease;
      display: flex; justify-content: space-between; gap: 10px; align-items: center;
    }
    .doc-item:hover { transform: translateY(-1px); border-color: rgba(255,255,255,0.18); }
    .doc-item .title { font-size: 13px; font-weight: 500; }
    .doc-item .status {
      font-size: 11px; padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      opacity: 0.9;
    }
    .signed { background: rgba(145,255,200,0.10); color: #91ffc8; border-color: rgba(145,255,200,0.28)!important; }
    .pending { background: rgba(255,210,125,0.10); color: #ffd27d; border-color: rgba(255,210,125,0.28)!important; }

    .viewer { display: grid; grid-template-rows: 1fr auto; height: 100%; }
    iframe { width: 100%; height: 100%; border: 0; background: #0a0d14; }
    .contentArea { height: 100%; overflow: auto; padding: 18px; }

    .sectionTitle {
      background: #2f5fb8;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 800;
      margin: 18px 0 12px;
      text-align: center;
      letter-spacing: 0.5px;
    }
    .formGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .field label {
      font-size: 12px;
      color: rgba(230,232,238,0.75);
      display: block;
      margin-bottom: 6px;
    }
    .field input, .field textarea, .field select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.02);
      color: #e6e8ee;
      outline: none;
      font-size: 13px;
    }
    textarea { min-height: 90px; resize: vertical; }
    .full { grid-column: 1 / -1; }

    .signature-area {
      padding: 14px;
      border-top: 1px solid rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    canvas {
      width: 100%;
      height: 140px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,0.20);
      background: rgba(255,255,255,0.02);
    }
    .buttons { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
    button {
      border: 0; padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all .2s ease;
    }
    .btn-clear { background: rgba(255,255,255,0.06); color: #e6e8ee; border: 1px solid rgba(255,255,255,0.10); }
    .btn-save { background: rgba(255,210,125,0.12); color: #ffd27d; border: 1px solid rgba(255,210,125,0.25); }
    .btn-sign { background: linear-gradient(90deg, #5b7cfa, #8e5bfa); color: white; }

    .muted { color: rgba(230,232,238,0.65); font-size: 12px; }
    .error {
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,80,80,0.12);
      border: 1px solid rgba(255,80,80,0.25);
      color: #ffb4b4;
      margin: 14px;
      font-size: 13px;
    }

    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; height: auto; }
      .viewer { height: 78vh; }
      .formGrid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<header>
  <h1>Portal de Firmas ‚Äî Cl√≠nica Privada</h1>
  <div class="badge" id="patientBadge">Cargando paciente‚Ä¶</div>
</header>

<main>
  <div class="panel doc-list">
    <h2>Documentos</h2>
    <div id="docs"></div>
    <p class="muted">Selecciona un documento para visualizarlo y firmarlo.</p>
  </div>

  <div class="panel viewer">
    <div id="docContainer" class="contentArea"></div>

    <div class="signature-area">
      <div class="muted" id="currentDocName">‚Äî</div>

      <canvas id="signaturePad"></canvas>

      <div class="buttons">
        <button class="btn-clear" onclick="clearSignature()">Borrar firma</button>
        <button class="btn-save" onclick="saveForm()">Guardar documento</button>
        <button class="btn-sign" onclick="signDocument()">Confirmar firma</button>
      </div>

      <div class="muted" id="statusText">Selecciona un documento antes de firmar.</div>
    </div>
  </div>
</main>

<script>
(function() {

  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("t");

  const docsContainer = document.getElementById("docs");
  const docContainer = document.getElementById("docContainer");
  const patientBadge = document.getElementById("patientBadge");
  const currentDocName = document.getElementById("currentDocName");
  const statusText = document.getElementById("statusText");

  let currentDocIndex = null;
  let currentPatient = null;

  const canvas = document.getElementById("signaturePad");
  const signaturePad = new SignaturePad(canvas);

  function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
    signaturePad.clear();
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  function showError(msg) {
    document.body.innerHTML = `<div class="error">${msg}</div>`;
  }

  if (!token) {
    showError("‚ö†Ô∏è Link inv√°lido. Falta el token del paciente.");
    return;
  }

  currentPatient = PATIENTS[token];
  if (!currentPatient) {
    showError("‚ö†Ô∏è Token no encontrado o desactivado.");
    return;
  }

  patientBadge.innerText = `Paciente: ${currentPatient.name}`;
  renderDocs();
  openDoc(0);

  function renderDocs() {
    docsContainer.innerHTML = "";
    currentPatient.docs.forEach((doc, index) => {
      const item = document.createElement("div");
      item.className = "doc-item";
      item.onclick = () => openDoc(index);

      const status = doc.signed ? "Firmado" : "Pendiente";
      const statusClass = doc.signed ? "status signed" : "status pending";
      item.innerHTML = `<div class="title">${doc.title}</div><div class="${statusClass}">${status}</div>`;
      docsContainer.appendChild(item);
    });
  }

  function openDoc(index) {
    currentDocIndex = index;
    const doc = currentPatient.docs[index];
    currentDocName.innerText = doc.title;
    signaturePad.clear();

    if (doc.type === "pdf") {
      docContainer.innerHTML = `<iframe src="${doc.url}"></iframe>`;
      statusText.innerText = doc.signed ? "‚úÖ Ya firmado." : "‚úçÔ∏è Firma y confirma.";
      toggleSave(false);
      return;
    }

    if (doc.type === "form") {
      docContainer.innerHTML = renderTemplate(doc.template);
      statusText.innerText = doc.signed ? "‚úÖ Ya firmado." : "üìù Llena, guarda y firma.";
      toggleSave(true);
      loadSavedForm();
      return;
    }

    docContainer.innerHTML = `<div class="error">Tipo desconocido: ${doc.type}</div>`;
  }

  function toggleSave(show) {
    document.querySelector(".btn-save").style.display = show ? "inline-block" : "none";
  }

  window.clearSignature = () => signaturePad.clear();

  // ====== Templates
  function renderTemplate(name) {
    if (name === "aviso_privacidad") return renderAviso();
    if (name === "consentimiento_masto") return renderMasto();
    if (name === "consentimiento_recto") return renderRecto();
    if (name === "historia_clinica") return renderHC();
    return `<div class="error">Template no encontrado: ${name}</div>`;
  }

  function renderAviso() {
    return `
      <div class="sectionTitle">AVISO DE PRIVACIDAD</div>
      <div class="muted" style="line-height:1.6;">
        En t√©rminos de lo previsto en la Ley Federal de Protecci√≥n de Datos Personales en Posesi√≥n de los Particulares...
      </div>

      <div class="sectionTitle">DATOS DEL PACIENTE</div>
      <div class="formGrid">
        <div class="field full"><label>Nombre completo*</label><input id="ap_nombre" /></div>
        <div class="field"><label>Fecha*</label><input id="ap_fecha" type="date"/></div>
        <div class="field full"><label><input id="ap_chk_acepto" type="checkbox"/> He le√≠do y acepto el Aviso de Privacidad*</label></div>
        <div class="field full"><label><input id="ap_chk_compartir" type="checkbox"/> Autorizo compartir resultados*</label></div>
      </div>
    `;
  }

  function renderMasto() {
    return `
      <div class="sectionTitle">CONSENTIMIENTO MASTOGRAF√çA</div>
      <div class="formGrid">
        <div class="field"><label>Fecha*</label><input id="masto_fecha" type="date"/></div>
        <div class="field full"><label>Nombre*</label><input id="masto_nombre"/></div>
        <div class="field"><label>Fecha nacimiento*</label><input id="masto_fn" type="date"/></div>
        <div class="field"><label>Edad*</label><input id="masto_edad" type="number"/></div>
        <div class="field full"><label>Direcci√≥n*</label><input id="masto_dir"/></div>
        <div class="field"><label>Colonia*</label><input id="masto_colonia"/></div>
        <div class="field"><label>Tel√©fono*</label><input id="masto_tel"/></div>
        <div class="field full"><label><input id="masto_chk" type="checkbox"/> Confirmo informaci√≥n y autorizo el estudio*</label></div>
      </div>
    `;
  }

  function renderRecto() {
    return `
      <div class="sectionTitle">CONSENTIMIENTO RECTOSIGMOIDOSCOP√çA</div>
      <div class="formGrid">
        <div class="field"><label>Fecha*</label><input id="recto_fecha" type="date"/></div>
        <div class="field full"><label>Nombre completo*</label><input id="recto_nombre"/></div>
        <div class="field"><label>Nacimiento*</label><input id="recto_fn" type="date"/></div>
        <div class="field"><label>Edad*</label><input id="recto_edad" type="number"/></div>
        <div class="field"><label>Sexo*</label><input id="recto_sexo"/></div>
        <div class="field full"><label><input id="recto_chk" type="checkbox"/> Confirmo consentimiento*</label></div>
        <div class="field full"><label><input id="recto_chk_alt" type="checkbox"/> Entiendo alternativas y urgencias*</label></div>
      </div>
    `;
  }

  function renderHC() {
    return `
      <div class="sectionTitle">HISTORIA CL√çNICA CHECK UP</div>
      <div class="formGrid">
        <div class="field full"><label>Nombre completo*</label><input id="hc_nombre"/></div>
        <div class="field"><label>Fecha nacimiento*</label><input id="hc_fn" type="date"/></div>
        <div class="field"><label>Edad*</label><input id="hc_edad" type="number"/></div>
        <div class="field full"><label>Domicilio*</label><input id="hc_dom"/></div>
        <div class="field"><label>Tel√©fono*</label><input id="hc_tel"/></div>
        <div class="field full"><label><input id="hc_declaro" type="checkbox"/> Declaro que la informaci√≥n es ver√≠dica*</label></div>
      </div>
    `;
  }

  // ===== Guardado local
  function getFormData() {
    const inputs = docContainer.querySelectorAll("input, textarea, select");
    const data = {};
    inputs.forEach(i => {
      if (!i.id) return;
      if (i.type === "checkbox") data[i.id] = i.checked ? "on" : "";
      else data[i.id] = i.value;
    });
    return data;
  }

  function loadSavedForm() {
    const doc = currentPatient.docs[currentDocIndex];
    const saved = localStorage.getItem("FORM_" + token + "_" + doc.template);
    if (!saved) return;
    const data = JSON.parse(saved);
    Object.keys(data).forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      if (el.type === "checkbox") el.checked = data[id] === "on";
      else el.value = data[id];
    });
  }

  window.saveForm = () => {
    if (currentDocIndex === null) return;
    const doc = currentPatient.docs[currentDocIndex];
    if (doc.type !== "form") return;
    localStorage.setItem("FORM_" + token + "_" + doc.template, JSON.stringify(getFormData()));
    statusText.innerText = "‚úÖ Guardado local.";
  };

  // ===== Validaci√≥n m√≠nima
  function validate(doc, data) {
    const required = (id, msg) => (!data[id] || data[id].trim() === "") ? msg : null;
    const check = (id, msg) => data[id] !== "on" ? msg : null;

    if (doc.template === "aviso_privacidad") {
      return required("ap_nombre","Falta Nombre") || required("ap_fecha","Falta Fecha")
        || check("ap_chk_acepto","Debes aceptar Aviso") || check("ap_chk_compartir","Debes autorizar compartir");
    }
    if (doc.template === "consentimiento_masto") {
      return required("masto_fecha","Falta Fecha") || required("masto_nombre","Falta Nombre")
        || check("masto_chk","Debes confirmar autorizaci√≥n");
    }
    if (doc.template === "consentimiento_recto") {
      return required("recto_fecha","Falta Fecha") || required("recto_nombre","Falta Nombre")
        || check("recto_chk","Falta consentimiento") || check("recto_chk_alt","Falta alternativas");
    }
    if (doc.template === "historia_clinica") {
      return required("hc_nombre","Falta Nombre") || required("hc_fn","Falta Nacimiento")
        || check("hc_declaro","Debes aceptar declaraci√≥n final");
    }
    return null;
  }

  // ===== Firmar + enviar
  window.signDocument = async () => {
    if (currentDocIndex === null) return;
    const doc = currentPatient.docs[currentDocIndex];

    if (signaturePad.isEmpty()) {
      statusText.innerText = "‚ö†Ô∏è Firma vac√≠a.";
      return;
    }

    let formData = null;

    if (doc.type === "form") {
      formData = getFormData();
      const err = validate(doc, formData);
      if (err) { statusText.innerText = "‚ö†Ô∏è " + err; return; }
      localStorage.setItem("FORM_" + token + "_" + doc.template, JSON.stringify(formData));
    }

    try {
      await fetch(BACKEND_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          token,
          patientName: currentPatient.name,
          docTitle: doc.title,
          docType: doc.type,
          formData,
          signature: signaturePad.toDataURL(),
          timestamp: new Date().toISOString()
        })
      });

      doc.signed = true;
      statusText.innerText = "‚úÖ Firma guardada.";
      renderDocs();

    } catch (e) {
      statusText.innerText = "‚ö†Ô∏è Error guardando. Revisa backend.";
      console.error(e);
    }
  };

})();
</script>

</body>
</html>
