<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portal de Firmas | Cl√≠nica</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="./data.js"></script>

  <style>
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: #0b0f19; color: #e6e8ee; }
    header {
      padding: 18px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(255,255,255,0.02);
      backdrop-filter: blur(10px);
    }
    header h1 { margin: 0; font-size: 16px; }
    header .badge {
      padding: 8px 12px; border-radius: 999px; font-size: 12px;
      background: rgba(145, 255, 200, 0.10);
      border: 1px solid rgba(145, 255, 200, 0.25);
      color: #91ffc8;
    }

    main {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      padding: 18px;
      height: calc(100vh - 70px);
    }

    .panel {
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      background: rgba(255,255,255,0.03);
      overflow: hidden;
    }

    .doc-list { padding: 14px; }
    .doc-list h2 { margin: 0 0 10px; font-size: 14px; font-weight: 700; color: #cfd6e6; }
    .doc-item {
      padding: 12px; border-radius: 12px; margin-bottom: 10px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.02);
      transition: all .2s ease;
      display: flex; justify-content: space-between; gap: 10px; align-items: center;
    }
    .doc-item:hover { transform: translateY(-1px); border-color: rgba(255,255,255,0.18); }
    .doc-item .title { font-size: 13px; font-weight: 500; }
    .doc-item .status {
      font-size: 11px; padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      opacity: 0.9;
    }
    .signed { background: rgba(145,255,200,0.10); color: #91ffc8; border-color: rgba(145,255,200,0.28)!important; }
    .pending { background: rgba(255,210,125,0.10); color: #ffd27d; border-color: rgba(255,210,125,0.28)!important; }

    .viewer { display: grid; grid-template-rows: 1fr auto; height: 100%; }
    iframe { width: 100%; height: 100%; border: 0; background: #0a0d14; }

    .contentArea { height: 100%; overflow: auto; padding: 18px; }

    .sectionTitle {
      background: #2f5fb8;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 800;
      margin: 18px 0 12px;
      text-align: center;
      letter-spacing: 0.5px;
    }

    .formGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .field label {
      font-size: 12px;
      color: rgba(230,232,238,0.75);
      display: block;
      margin-bottom: 6px;
    }
    .field input, .field textarea, .field select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.02);
      color: #e6e8ee;
      outline: none;
      font-size: 13px;
    }
    textarea { min-height: 90px; resize: vertical; }
    .full { grid-column: 1 / -1; }

    .signature-area {
      padding: 14px;
      border-top: 1px solid rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .signature-area h3 {
      margin: 0;
      font-size: 13px;
      font-weight: 700;
      color: #cfd6e6;
      display: flex;
      justify-content: space-between;
    }

    canvas {
      width: 100%;
      height: 140px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,0.20);
      background: rgba(255,255,255,0.02);
    }

    .buttons { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
    button {
      border: 0; padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all .2s ease;
    }
    .btn-clear { background: rgba(255,255,255,0.06); color: #e6e8ee; border: 1px solid rgba(255,255,255,0.10); }
    .btn-clear:hover { background: rgba(255,255,255,0.10); }

    .btn-save { background: rgba(255,210,125,0.12); color: #ffd27d; border: 1px solid rgba(255,210,125,0.25); }
    .btn-save:hover { background: rgba(255,210,125,0.18); transform: translateY(-1px); }

    .btn-sign { background: linear-gradient(90deg, #5b7cfa, #8e5bfa); color: white; }
    .btn-sign:hover { opacity: 0.9; transform: translateY(-1px); }

    .muted { color: rgba(230,232,238,0.65); font-size: 12px; }
    .error {
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,80,80,0.12);
      border: 1px solid rgba(255,80,80,0.25);
      color: #ffb4b4;
      margin: 14px;
      font-size: 13px;
    }

    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; height: auto; }
      .viewer { height: 78vh; }
      .formGrid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<header>
  <h1>Portal de Firmas ‚Äî Cl√≠nica Privada</h1>
  <div class="badge" id="patientBadge">Cargando paciente‚Ä¶</div>
</header>

<main>
  <div class="panel doc-list">
    <h2>Documentos</h2>
    <div id="docs"></div>
    <p class="muted">Selecciona un documento para visualizarlo y firmarlo.</p>
  </div>

  <div class="panel viewer">
    <!-- Aqu√≠ se carga PDF o Formulario -->
    <div id="docContainer" class="contentArea"></div>

    <div class="signature-area">
      <h3>Firma del paciente <span class="muted" id="currentDocName">‚Äî</span></h3>

      <canvas id="signaturePad"></canvas>

      <div class="buttons">
        <button class="btn-clear" onclick="clearSignature()">Borrar firma</button>
        <button class="btn-save" onclick="saveForm()">Guardar Historia Cl√≠nica</button>
        <button class="btn-sign" onclick="signDocument()">Confirmar firma</button>
      </div>

      <div class="muted" id="statusText">Selecciona un documento antes de firmar.</div>
    </div>
  </div>
</main>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("t");

  const docsContainer = document.getElementById("docs");
  const docContainer = document.getElementById("docContainer");
  const patientBadge = document.getElementById("patientBadge");
  const currentDocName = document.getElementById("currentDocName");
  const statusText = document.getElementById("statusText");

  let currentDocIndex = null;
  let currentPatient = null;

  const canvas = document.getElementById("signaturePad");
  const signaturePad = new SignaturePad(canvas);

  function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
    signaturePad.clear();
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  function showError(msg) {
    document.body.innerHTML = `<div class="error">${msg}</div>`;
  }

  if (!token) {
    showError("‚ö†Ô∏è Link inv√°lido. Falta el token del paciente.");
  } else {
    currentPatient = PATIENTS[token];
    if (!currentPatient) showError("‚ö†Ô∏è Token no encontrado. Este link no existe o ya fue desactivado.");
    else {
      patientBadge.innerText = `Paciente: ${currentPatient.name}`;
      renderDocs();
    }
  }

  function renderDocs() {
    docsContainer.innerHTML = renderTemplate(doc.template || "historia_clinica");;
    currentPatient.docs.forEach((doc, index) => {
      const item = document.createElement("div");
      item.className = "doc-item";
      item.onclick = () => openDoc(index);

      const status = doc.signed ? "Firmado" : "Pendiente";
      const statusClass = doc.signed ? "status signed" : "status pending";

      item.innerHTML = `<div class="title">${doc.title}</div><div class="${statusClass}">${status}</div>`;
      docsContainer.appendChild(item);
    });

    if (currentPatient.docs[0]) openDoc(0);
  }

  function openDoc(index) {
    currentDocIndex = index;
    const doc = currentPatient.docs[index];

    currentDocName.innerText = doc.title;
    statusText.innerText = "DEBUG -> type: " + doc.type + " | template: " + doc.template;
    signaturePad.clear();

    // Si es PDF ‚Üí mostrar iframe
    if (doc.type === "pdf") {
      docContainer.innerHTML = `<iframe src="${doc.url}"></iframe>`;
      statusText.innerText = doc.signed ? "‚úÖ Este documento ya fue firmado." : "‚úçÔ∏è Firma dentro del recuadro y presiona Confirmar firma.";
      toggleSaveButton(false);
    }

    // Si es Historia Cl√≠nica ‚Üí mostrar formulario
 if (doc.type === "form") {
  docContainer.innerHTML = renderTemplate(doc.template);
  statusText.innerText = doc.signed ? "‚úÖ Documento ya firmado." : "üìù Llena el documento, guarda y firma.";
  toggleSaveButton(true);
  loadSavedForm();
    }
  }

  function toggleSaveButton(show) {
    document.querySelector(".btn-save").style.display = show ? "inline-block" : "none";
  }

  function clearSignature() {
    signaturePad.clear();
  }

  // -----------------------------
  // HISTORIA CL√çNICA (editable)
  // -----------------------------
  function renderHistoriaClinica() {
    return `
      <div class="sectionTitle">HISTORIA CL√çNICA CHECK UP</div>
      <p class="muted" style="text-align:center;font-weight:700;">*FAVOR DE LEER Y LLENAR DETENIDAMENTE*</p>

      <div class="formGrid">
        <div class="field full"><label>Nombre completo*</label><input id="hc_nombre" /></div>
        <div class="field"><label>Fecha de nacimiento*</label><input id="hc_fn" type="date"/></div>
        <div class="field"><label>Edad*</label><input id="hc_edad" type="number"/></div>
        <div class="field"><label>G√©nero*</label>
          <select id="hc_genero">
            <option value="">Selecciona</option>
            <option>Masculino</option>
            <option>Femenino</option>
            <option>Otro</option>
          </select>
        </div>
        <div class="field"><label>Estado civil*</label><input id="hc_ec" /></div>
        <div class="field"><label>Lugar de nacimiento*</label><input id="hc_ln" /></div>
        <div class="field full"><label>Domicilio*</label><input id="hc_dom" /></div>
        <div class="field"><label>Tel√©fono*</label><input id="hc_tel" /></div>
        <div class="field"><label>Correo*</label><input id="hc_correo" type="email"/></div>
        <div class="field full"><label>Contacto de emergencia*</label><input id="hc_emerg" /></div>
        <div class="field"><label>Grado escolaridad*</label><input id="hc_escolar" /></div>
        <div class="field full"><label>Nombre de la empresa o lugar donde trabaja actualmente</label><input id="hc_empresa" /></div>
        <div class="field full"><label>Puesto o cargo en su lugar de trabajo</label><input id="hc_puesto" /></div>
      </div>

      <div class="sectionTitle">ANTECEDENTES HEREDO FAMILIARES</div>

      <div class="formGrid">
        <div class="field"><label>C√°ncer (SI/NO)</label>
          <select id="hf_cancer"><option value="">Selecciona</option><option>SI</option><option>NO</option></select>
        </div>
        <div class="field"><label>¬øQui√©n?</label><input id="hf_cancer_quien"/></div>

        <div class="field"><label>Diabetes Mellitus (SI/NO)</label>
          <select id="hf_dm"><option value="">Selecciona</option><option>SI</option><option>NO</option></select>
        </div>
        <div class="field"><label>¬øQui√©n?</label><input id="hf_dm_quien"/></div>

        <div class="field"><label>Hipertensi√≥n (SI/NO)</label>
          <select id="hf_hta"><option value="">Selecciona</option><option>SI</option><option>NO</option></select>
        </div>
        <div class="field"><label>¬øQui√©n?</label><input id="hf_hta_quien"/></div>

        <div class="field"><label>Enfermedades autoinmunes (SI/NO)</label>
          <select id="hf_auto"><option value="">Selecciona</option><option>SI</option><option>NO</option></select>
        </div>
        <div class="field"><label>¬øQui√©n?</label><input id="hf_auto_quien"/></div>

        <div class="field"><label>Infarto < 50 a√±os (SI/NO)</label>
          <select id="hf_infarto"><option value="">Selecciona</option><option>SI</option><option>NO</option></select>
        </div>
        <div class="field"><label>¬øQui√©n?</label><input id="hf_infarto_quien"/></div>

        <div class="field"><label>Otras enfermedades (SI/NO)</label>
          <select id="hf_otras"><option value="">Selecciona</option><option>SI</option><option>NO</option></select>
        </div>
        <div class="field"><label>¬øQui√©n?</label><input id="hf_otras_quien"/></div>
      </div>

      <div class="sectionTitle">EXPLORACI√ìN F√çSICA</div>
      <p class="muted" style="text-align:center;font-weight:700;">*SE LLENA EL D√çA DE SU CHECK UP POR NUESTRO PERSONAL*</p>

      <div class="formGrid">
        <div class="field"><label>Presi√≥n arterial</label><input id="ef_pa"/></div>
        <div class="field"><label>Frecuencia card√≠aca</label><input id="ef_fc"/></div>
        <div class="field"><label>Frecuencia respiratoria</label><input id="ef_fr"/></div>
        <div class="field"><label>Talla (m)</label><input id="ef_talla"/></div>
        <div class="field"><label>Peso (kg)</label><input id="ef_peso"/></div>
        <div class="field"><label>IMC</label><input id="ef_imc"/></div>
        <div class="field"><label>Saturaci√≥n O2</label><input id="ef_o2"/></div>
        <div class="field"><label>Temperatura</label><input id="ef_temp"/></div>
      </div>

      <div class="sectionTitle">ANTECEDENTES GINECO OBST√âTRICOS (solo mujeres)</div>
      <div class="formGrid">
        <div class="field"><label>Primera menstruaci√≥n (edad)</label><input id="go_pm"/></div>
        <div class="field"><label>Fecha √∫ltima menstruaci√≥n</label><input id="go_fum" type="date"/></div>
        <div class="field full"><label>Frecuencia de periodos menstruales</label><input id="go_freq"/></div>
        <div class="field"><label>Duraci√≥n del periodo por d√≠as</label><input id="go_duracion"/></div>

        <div class="field"><label>Embarazos</label><input id="go_emb"/></div>
        <div class="field"><label>Partos</label><input id="go_partos"/></div>
        <div class="field"><label>Ces√°reas</label><input id="go_cesareas"/></div>
        <div class="field"><label>Abortos</label><input id="go_abortos"/></div>

        <div class="field"><label>√öltimo parto (fecha)</label><input id="go_ult_parto" type="date"/></div>
        <div class="field"><label>√öltima ces√°rea (fecha)</label><input id="go_ult_ces" type="date"/></div>
        <div class="field"><label>√öltimo aborto (fecha)</label><input id="go_ult_ab" type="date"/></div>

        <div class="field full"><label>Complicaciones en parto o ces√°rea</label><input id="go_comp"/></div>

        <div class="field"><label>Uso anticonceptivos</label>
          <select id="go_anticon"><option value="">Selecciona</option><option>SI</option><option>NO</option></select>
        </div>
        <div class="field"><label>Tiempo de uso</label><input id="go_tiempo"/></div>

        <div class="field full"><label>Enfermedades transmisi√≥n sexual</label><input id="go_ets"/></div>
        <div class="field full"><label>Autoexploraci√≥n de mamas (frecuencia)</label><input id="go_mamas"/></div>
        <div class="field full"><label>√öltimo papanicolaou (fecha y resultado)</label><input id="go_pap"/></div>

        <div class="field"><label>Ultrasonido mamario (fecha)</label><input id="go_us_mam"/></div>
        <div class="field"><label>Mastograf√≠a (fecha)</label><input id="go_masto"/></div>
        <div class="field"><label>Ninguno</label>
          <select id="go_none"><option value="">Selecciona</option><option>SI</option><option>NO</option></select>
        </div>
      </div>

      <div class="sectionTitle">APARATOS Y SISTEMAS</div>
      <div class="formGrid">
        <div class="field"><label>S√≠ntomas generales (SI/NO)</label><select id="as_sg"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field full"><label>¬øCu√°les? / Describir ampliamente</label><textarea id="as_sg_desc"></textarea></div>

        <div class="field"><label>√ìrganos de los sentidos (SI/NO)</label><select id="as_os"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field full"><label>¬øCu√°les? / Describir ampliamente</label><textarea id="as_os_desc"></textarea></div>

        <div class="field"><label>Neuropsiqui√°trico (SI/NO)</label><select id="as_np"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field full"><label>¬øCu√°les? / Describir ampliamente</label><textarea id="as_np_desc"></textarea></div>

        <div class="field"><label>Respiratorio (SI/NO)</label><select id="as_resp"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field full"><label>¬øCu√°les? / Describir ampliamente</label><textarea id="as_resp_desc"></textarea></div>

        <div class="field"><label>Piel y faneras (SI/NO)</label><select id="as_piel"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field full"><label>¬øCu√°les? / Describir ampliamente</label><textarea id="as_piel_desc"></textarea></div>

        <div class="field"><label>M√∫sculo esquel√©tico (SI/NO)</label><select id="as_me"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field full"><label>¬øCu√°les? / Describir ampliamente</label><textarea id="as_me_desc"></textarea></div>

        <div class="field"><label>Hematopoy√©tico (SI/NO)</label><select id="as_hema"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field full"><label>¬øCu√°les? / Describir ampliamente</label><textarea id="as_hema_desc"></textarea></div>

        <div class="field"><label>Contagio por COVID/Influenza</label><select id="as_covid"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field"><label>¬øCu√°ndo?</label><input id="as_covid_cuando"/></div>
        <div class="field full"><label>Secuelas percibidas</label><textarea id="as_covid_secuelas"></textarea></div>

        <div class="field full"><label>Si toma medicamentos, indique cu√°les, dosis y desde cu√°ndo</label><textarea id="as_meds"></textarea></div>

        <div class="field"><label>Gastrointestinal (SI/NO)</label><select id="as_gi"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field full"><label>¬øCu√°les? / Describir ampliamente</label><textarea id="as_gi_desc"></textarea></div>

        <div class="field"><label>Cardiovascular (SI/NO)</label><select id="as_cardio"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field full"><label>¬øCu√°les? / Describir ampliamente</label><textarea id="as_cardio_desc"></textarea></div>

        <div class="field"><label>Urinario y genital (SI/NO)</label><select id="as_ug"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field full"><label>¬øCu√°les? / Describir ampliamente</label><textarea id="as_ug_desc"></textarea></div>
      </div>

      <div class="sectionTitle">ANTECEDENTES PERSONALES PATOL√ìGICOS</div>
      <div class="formGrid">
        <div class="field"><label>Alergias (SI/NO)</label><select id="app_alergias"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field"><label>Tipo de alergia</label><input id="app_tipo_alergia"/></div>

        <div class="field full"><label>Alcohol: frecuencia (d√≠as/semana)</label><input id="app_alcohol_freq"/></div>
        <div class="field full"><label>Tipo de alcohol</label><input id="app_alcohol_tipo"/></div>
        <div class="field"><label>Cantidad por d√≠a</label><input id="app_alcohol_cant"/></div>
        <div class="field"><label>Edad de inicio</label><input id="app_alcohol_inicio"/></div>
        <div class="field"><label>Edad de t√©rmino (si suspendi√≥)</label><input id="app_alcohol_fin"/></div>

        <div class="field full"><label>Tabaco: frecuencia (d√≠as/semana)</label><input id="app_tabaco_freq"/></div>
        <div class="field full"><label>Cantidad cigarrillos por d√≠a</label><input id="app_tabaco_cant"/></div>
        <div class="field"><label>Edad de inicio</label><input id="app_tabaco_inicio"/></div>
        <div class="field"><label>Edad de t√©rmino (si suspendi√≥)</label><input id="app_tabaco_fin"/></div>

        <div class="field full"><label>Traumatismos (fracturas, cr√°neo, columna, etc.)</label><textarea id="app_trauma"></textarea></div>
      </div>

      <div class="sectionTitle">ANTECEDENTES PERSONALES NO PATOL√ìGICOS</div>
      <div class="formGrid">
        <div class="field"><label>Frecuencia de ba√±o a la semana</label><input id="apnp_bano"/></div>
        <div class="field"><label>Frecuencia aseo dental al d√≠a</label><input id="apnp_dental"/></div>

        <div class="field full"><label>Alimentaci√≥n (anote cu√°ntas veces/semana)</label><textarea id="apnp_alimentacion"></textarea></div>

        <div class="field"><label>Actividad f√≠sica (d√≠as/semana)</label><input id="apnp_af_dias"/></div>
        <div class="field"><label>Tipo de ejercicio</label><input id="apnp_af_tipo"/></div>
        <div class="field"><label>Duraci√≥n por d√≠a (hrs)</label><input id="apnp_af_dur"/></div>

        <div class="field full"><label>Vacunaci√≥n (aplicadas a√±o presente y anterior)</label><textarea id="apnp_vac"></textarea></div>

        <div class="field"><label>Mascota (Perro/Gato/Otro)</label><input id="apnp_mascota"/></div>
        <div class="field"><label>Cantidad</label><input id="apnp_mascota_cant"/></div>

        <div class="field"><label>Viajes recientes (fecha)</label><input id="apnp_viajes_fecha" type="date"/></div>
        <div class="field"><label>Regi√≥n geogr√°fica</label><input id="apnp_viajes_region"/></div>
      </div>

      <div class="sectionTitle">HOSPITALIZACIONES</div>
      <div class="formGrid">
        <div class="field"><label>Hospitalizaciones (SI/NO)</label><select id="hos_si"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field"><label>Duraci√≥n en d√≠as</label><input id="hos_dias"/></div>
        <div class="field full"><label>Motivos</label><textarea id="hos_motivos"></textarea></div>

        <div class="field"><label>Grupo sangu√≠neo</label><input id="hos_grupo"/></div>
        <div class="field"><label>Transfusiones (SI/NO)</label><select id="hos_trans"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field full"><label>Cantidad</label><input id="hos_cant"/></div>

        <div class="field full"><label>Eventos quir√∫rgicos (anotar cirug√≠as y a√±o)</label><textarea id="hos_qx"></textarea></div>

        <div class="field full"><label>Enfermedades diagnosticadas previamente (anote nombre, a√±o y tratamiento)</label><textarea id="hos_enf"></textarea></div>

        <div class="field full"><label>Describir s√≠ntomas actuales cercanos al check up</label><textarea id="hos_sintomas"></textarea></div>
      </div>

      <div class="sectionTitle">DECLARACI√ìN FINAL</div>
      <p class="muted" style="text-align:center;font-weight:700;">
        ‚ÄúPOR MEDIO DE LA PRESENTE DECLARO QUE LA INFORMACI√ìN OTORGADA EN ESTA HISTORIA CL√çNICA ES VER√çDICA Y COMPLETA‚Ä¶‚Äù
      </p>

      <div class="muted" style="margin-top:14px;">
        ‚úÖ Al terminar, presiona ‚ÄúGuardar Historia Cl√≠nica‚Äù y luego firma abajo.
      </div>
    `;
  }
  function renderTemplate(templateName) {
  if (templateName === "historia_clinica") return renderHistoriaClinica();
  if (templateName === "aviso_privacidad") return renderAvisoPrivacidad();
  if (templateName === "consentimiento_masto") return renderConsentimientoMasto();
  if (templateName === "consentimiento_recto") return renderConsentimientoRecto();

  return `<div class="error">Template no encontrado: ${templateName}</div>`;
  }
  function renderAvisoPrivacidad() {
  return `
    <div class="sectionTitle">AVISO DE PRIVACIDAD</div>

    <div class="muted" style="line-height:1.6;">
      En t√©rminos de lo previsto en la Ley Federal de Protecci√≥n de Datos Personales en Posesi√≥n de los Particulares
      (en lo sucesivo denominada como ‚ÄúLa Ley‚Äù), le pedimos que lea cuidadosamente los T√©rminos y Condiciones contenidos
      en este Aviso de Privacidad, ya que la simple aportaci√≥n que haga de sus datos Personales mediante su env√≠o a
      OPERADORA Y ADMINISTRADORA DE HOSPITALES SAN JOSE S.A DE C.V., ya sea a trav√©s de nuestra p√°gina de internet; y/o
      al correo electr√≥nico, constituye la aceptaci√≥n de estos T√©rminos y Condiciones y en consecuencia nos autoriza
      expresamente al tratamiento de sus datos personales:
    </div>

    <div class="sectionTitle">T√âRMINOS Y CONDICIONES</div>
    <div class="muted" style="line-height:1.65;">
      <b>1.</b> El presente Aviso tiene por objeto la protecci√≥n de sus datos personales...<br><br>
      <b>2.</b> Conforme al Art√≠culo 3, fracci√≥n V, de la Ley...<br><br>
      <b>3.</b> Operadora y Administradora de Hospitales San Jos√© S.A de C.V...<br><br>
      <b>4.</b> Mantener informados a sus clientes...<br><br>
      <b>5.</b> La temporalidad del manejo de sus Datos Personales ser√° indefinida...<br><br>
      <b>6.</b> Se compromete a guardar estricta confidencialidad...<br><br>
      <b>7.</b> Derechos ARCO: acceso, rectificaci√≥n, cancelaci√≥n y oposici√≥n...<br><br>
      <b>8.</b> Le sugerimos conocer y analizar la Ley...
    </div>

    <div class="sectionTitle">AUTORIZACI√ìN</div>
    <div class="muted" style="font-weight:700; text-align:center; line-height:1.6;">
      AUTORIZO QUE LOS RESULTADOS DE MIS EX√ÅMENES M√âDICOS SEAN COMPARTIDOS CON EL GRUPO DE M√âDICOS QUE SE ENCUENTRAN EN MI REVISI√ìN.
    </div>

    <div class="formGrid" style="margin-top:14px;">
      <div class="field full">
        <label>Nombre completo del paciente*</label>
        <input id="ap_nombre" />
      </div>

      <div class="field">
        <label>Fecha (D√≠a/Mes/A√±o)*</label>
        <input id="ap_fecha" type="date" />
      </div>

      <div class="field full">
        <label>
          <input id="ap_chk_acepto" type="checkbox" />
          He le√≠do y acepto el Aviso de Privacidad y autorizo el tratamiento de mis datos personales.*
        </label>
      </div>

      <div class="field full">
        <label>
          <input id="ap_chk_compartir" type="checkbox" />
          Autorizo que mis resultados sean compartidos con el grupo de m√©dicos en mi revisi√≥n.*
        </label>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      ‚úÖ Completa los campos, marca las casillas y luego firma en la secci√≥n inferior.
    </div>
  `;
}
  function renderConsentimientoMasto() {
  return `
    <div class="sectionTitle">CHECK UP</div>
    <div class="sectionTitle">CONSENTIMIENTO INFORMADO PARA ESTUDIO DE MASTOGRAF√çA</div>

    <div class="formGrid">
      <div class="field"><label>Fecha*</label><input id="masto_fecha" type="date"/></div>
      <div class="field full"><label>Nombre*</label><input id="masto_nombre"/></div>
      <div class="field"><label>Fecha de nacimiento*</label><input id="masto_fn" type="date"/></div>
      <div class="field"><label>Edad*</label><input id="masto_edad" type="number"/></div>
      <div class="field full"><label>Direcci√≥n*</label><input id="masto_dir"/></div>
      <div class="field"><label>Colonia*</label><input id="masto_colonia"/></div>
      <div class="field"><label>Tel√©fono*</label><input id="masto_tel"/></div>
      <div class="field full"><label>M√©dico (se llena en cl√≠nica)</label><input id="masto_medico" disabled value="(Se llena en cl√≠nica)"/></div>
    </div>

    <div class="sectionTitle">ANTECEDENTES FAMILIARES PERSONALES</div>
    <div class="formGrid">
      <div class="field">
        <label>¬øAlguien de su familia ha padecido c√°ncer de mama?*</label>
        <select id="masto_cancer">
          <option value="">Selecciona</option><option>Si</option><option>No</option>
        </select>
      </div>
      <div class="field">
        <label>¬øQui√©n?</label>
        <input id="masto_quien"/>
      </div>

      <div class="field"><label>Fecha de su primera menstruaci√≥n</label><input id="masto_pm" type="date"/></div>
      <div class="field"><label>Fecha de su √∫ltima menstruaci√≥n</label><input id="masto_um" type="date"/></div>

      <div class="field"><label>¬øCu√°ntos d√≠as dura?</label><input id="masto_dias"/></div>
      <div class="field"><label>¬øSus periodos son regulares?</label><input id="masto_regulares"/></div>

      <div class="field">
        <label>¬øToma alg√∫n medicamento?*</label>
        <select id="masto_meds"><option value="">Selecciona</option><option>Si</option><option>No</option></select>
      </div>
      <div class="field full"><label>¬øCu√°l?</label><input id="masto_meds_cual"/></div>
      <div class="field"><label>Dosis</label><input id="masto_meds_dosis"/></div>
      <div class="field full"><label>¬øCu√°nto tiempo?</label><input id="masto_meds_tiempo"/></div>

      <div class="field">
        <label>Hormonas*</label>
        <select id="masto_horm"><option value="">Selecciona</option><option>Si</option><option>No</option></select>
      </div>
      <div class="field full"><label>¬øCu√°l?</label><input id="masto_horm_cual"/></div>
      <div class="field"><label>Dosis</label><input id="masto_horm_dosis"/></div>
      <div class="field full"><label>¬øCu√°nto tiempo?</label><input id="masto_horm_tiempo"/></div>

      <div class="field"><label>N√∫mero de embarazos</label><input id="masto_emb"/></div>
      <div class="field"><label>N√∫mero de hijos</label><input id="masto_hijos"/></div>
      <div class="field full"><label>Edades</label><input id="masto_edades"/></div>
      <div class="field full"><label>¬øAmamant√≥ a sus hijos?</label><input id="masto_amamanto"/></div>

      <div class="field full">
        <label>
          <input id="masto_chk" type="checkbox"/>
          Confirmo que la informaci√≥n proporcionada es verdadera y autorizo el estudio.*
        </label>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      ‚úÖ Completa los campos obligatorios, marca la casilla y luego firma en la secci√≥n inferior.
    </div>
  `;
}
  function renderConsentimientoRecto() {
  return `
    <div class="sectionTitle">CHECK UP</div>
    <div class="sectionTitle">CONSENTIMIENTO INFORMADO PARA ESTUDIO DE RECTOSIGMOIDOSCOP√çA</div>

    <div class="muted" style="line-height:1.65;">
      Este documento sirve para que usted, o qui√©n represente, d√© su consentimiento para la realizaci√≥n del estudio de Rectosigmoidoscop√≠a.
      Usted puede elegir no aceptar el procedimiento... Antes de firmar es importante que lea despacio la siguiente informaci√≥n.
    </div>

    <div class="sectionTitle">EN QU√â CONSISTE Y PARA QU√â SIRVE</div>
    <div class="muted" style="line-height:1.65;">
      Previa dilataci√≥n y lubricaci√≥n anal, se realiza una exploraci√≥n visual con un aparato flexible de fibra √≥ptica...
    </div>

    <div class="sectionTitle">RIESGOS DEL PROCEDIMIENTO</div>
    <div class="muted" style="line-height:1.65;">
      Puede presentarse con poca frecuencia algunos riesgos comunes derivados de todo procedimiento como: perforaci√≥n, hemorragia...
    </div>

    <div class="sectionTitle">DATOS DEL PACIENTE</div>
    <div class="formGrid">
      <div class="field"><label>Fecha*</label><input id="recto_fecha" type="date"/></div>
      <div class="field full"><label>Nombre completo*</label><input id="recto_nombre"/></div>
      <div class="field"><label>Fecha de nacimiento*</label><input id="recto_fn" type="date"/></div>
      <div class="field"><label>Edad*</label><input id="recto_edad" type="number"/></div>
      <div class="field"><label>Sexo*</label><input id="recto_sexo"/></div>

      <div class="field full">
        <label>M√©dico (se llena en cl√≠nica)</label>
        <input id="recto_dr" disabled value="(Se llena en cl√≠nica)" />
      </div>

      <div class="field full">
        <label>
          <input id="recto_chk" type="checkbox"/>
          Confirmo que he le√≠do la informaci√≥n, se aclararon mis dudas y otorgo mi consentimiento de manera libre y voluntaria.*
        </label>
      </div>

      <div class="field full">
        <label>
          <input id="recto_chk_alt" type="checkbox"/>
          Entiendo que existen alternativas y que el m√©dico podr√° actuar ante contingencias y urgencias.*
        </label>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      ‚úÖ Completa los campos obligatorios, marca las casillas y luego firma en la secci√≥n inferior.
    </div>
  `;
}

  // Guardado local (para no perder datos si se sale)
  function getFormData() {
    const inputs = docContainer.querySelectorAll("input, textarea, select");
    const data = {};
    inputs.forEach(i => data[i.id] = i.value);
    return data;
  }

  function loadSavedForm() {
    const doc = currentPatient.docs[currentDocIndex];
const saved = localStorage.getItem("HC_" + token + "_" + doc.template);
    if (!saved) return;
    const data = JSON.parse(saved);
    Object.keys(data).forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = data[id];
    });
  }

  function saveForm() {
    if (currentDocIndex === null) return;
    const doc = currentPatient.docs[currentDocIndex];
    if (doc.type !== "form") return;

    const data = getFormData();
   localStorage.setItem("HC_" + token + "_" + doc.template, JSON.stringify(data));
    statusText.innerText = "‚úÖ Historia cl√≠nica guardada (local). Ahora firma y confirma.";
  }

  // -----------------------------
  // FIRMAR DOCUMENTO
  // -----------------------------
  async function signDocument() {
    if (currentDocIndex === null) return;

    const doc = currentPatient.docs[currentDocIndex];

    if (signaturePad.isEmpty()) {
      statusText.innerText = "‚ö†Ô∏è La firma est√° vac√≠a. Firma antes de confirmar.";
      return;
    }

    // Si es historia cl√≠nica ‚Üí debe estar guardada
    let formData = null;
    if (doc.type === "form") {
  formData = getFormData();

  const valid = validateTemplate(doc.template, formData);
  if (!valid.ok) {
    statusText.innerText = "‚ö†Ô∏è " + valid.msg;
    return;
  }
  localStorage.setItem("HC_" + token + "_" + doc.template, JSON.stringify(formData));
}
    const signature = signaturePad.toDataURL();

    // Guardado remoto (Apps Script)
    try {
      await fetch(BACKEND_URL, {
        method: "POST",
        body: JSON.stringify({
          token,
          patientName: currentPatient.name,
          docTitle: doc.title,
          docType: doc.type,
          formData,
          signature,
          timestamp: new Date().toISOString()
        }),
        headers: { "Content-Type": "text/plain;charset=utf-8" }
      });

      currentPatient.docs[currentDocIndex].signed = true;
      statusText.innerText = "‚úÖ Firma registrada y enviada.";
      renderDocs();

    } catch (err) {
      console.error(err);
      statusText.innerText = "‚ö†Ô∏è Error al guardar. Revisa BACKEND_URL y permisos.";
    }
  }
</script>
</body>
</html>
