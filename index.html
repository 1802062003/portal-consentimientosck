<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portal de Firmas | Cl√≠nica</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="./data.js"></script>

  <style>
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: #0b0f19; color: #e6e8ee; }
    header {
      padding: 18px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(255,255,255,0.02);
      backdrop-filter: blur(10px);
    }
    header h1 { margin: 0; font-size: 16px; }
    header .badge {
      padding: 8px 12px; border-radius: 999px; font-size: 12px;
      background: rgba(145, 255, 200, 0.10);
      border: 1px solid rgba(145, 255, 200, 0.25);
      color: #91ffc8;
    }

    main {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      padding: 18px;
      height: calc(100vh - 70px);
    }

    .panel {
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      background: rgba(255,255,255,0.03);
      overflow: hidden;
    }

    .doc-list { padding: 14px; }
    .doc-list h2 { margin: 0 0 10px; font-size: 14px; font-weight: 700; color: #cfd6e6; }
    .doc-item {
      padding: 12px; border-radius: 12px; margin-bottom: 10px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.02);
      transition: all .2s ease;
      display: flex; justify-content: space-between; gap: 10px; align-items: center;
    }
    .doc-item:hover { transform: translateY(-1px); border-color: rgba(255,255,255,0.18); }
    .doc-item .title { font-size: 13px; font-weight: 500; }
    .doc-item .status {
      font-size: 11px; padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      opacity: 0.9;
    }
    .signed { background: rgba(145,255,200,0.10); color: #91ffc8; border-color: rgba(145,255,200,0.28)!important; }
    .pending { background: rgba(255,210,125,0.10); color: #ffd27d; border-color: rgba(255,210,125,0.28)!important; }

    .viewer { display: grid; grid-template-rows: 1fr auto; height: 100%; }
    iframe { width: 100%; height: 100%; border: 0; background: #0a0d14; }

    .contentArea { height: 100%; overflow: auto; padding: 18px; }

    .sectionTitle {
      background: #2f5fb8;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 800;
      margin: 18px 0 12px;
      text-align: center;
      letter-spacing: 0.5px;
    }

    .formGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .field label {
      font-size: 12px;
      color: rgba(230,232,238,0.75);
      display: block;
      margin-bottom: 6px;
    }
    .field input, .field textarea, .field select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.02);
      color: #e6e8ee;
      outline: none;
      font-size: 13px;
    }
    textarea { min-height: 90px; resize: vertical; }
    .full { grid-column: 1 / -1; }

    .signature-area {
      padding: 14px;
      border-top: 1px solid rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .signature-area h3 {
      margin: 0;
      font-size: 13px;
      font-weight: 700;
      color: #cfd6e6;
      display: flex;
      justify-content: space-between;
    }

    canvas {
      width: 100%;
      height: 140px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,0.20);
      background: rgba(255,255,255,0.02);
    }

    .buttons { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
    button {
      border: 0; padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all .2s ease;
    }
    .btn-clear { background: rgba(255,255,255,0.06); color: #e6e8ee; border: 1px solid rgba(255,255,255,0.10); }
    .btn-clear:hover { background: rgba(255,255,255,0.10); }

    .btn-save { background: rgba(255,210,125,0.12); color: #ffd27d; border: 1px solid rgba(255,210,125,0.25); }
    .btn-save:hover { background: rgba(255,210,125,0.18); transform: translateY(-1px); }

    .btn-sign { background: linear-gradient(90deg, #5b7cfa, #8e5bfa); color: white; }
    .btn-sign:hover { opacity: 0.9; transform: translateY(-1px); }

    .muted { color: rgba(230,232,238,0.65); font-size: 12px; }
    .error {
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,80,80,0.12);
      border: 1px solid rgba(255,80,80,0.25);
      color: #ffb4b4;
      margin: 14px;
      font-size: 13px;
    }

    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; height: auto; }
      .viewer { height: 78vh; }
      .formGrid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<header>
  <h1>Portal de Firmas ‚Äî Cl√≠nica Privada</h1>
  <div class="badge" id="patientBadge">Cargando paciente‚Ä¶</div>
</header>

<main>
  <div class="panel doc-list">
    <h2>Documentos</h2>
    <div id="docs"></div>
    <p class="muted">Selecciona un documento para visualizarlo y firmarlo.</p>
  </div>

  <div class="panel viewer">
    <div id="docContainer" class="contentArea"></div>

    <div class="signature-area">
      <h3>Firma del paciente <span class="muted" id="currentDocName">‚Äî</span></h3>

      <canvas id="signaturePad"></canvas>

      <div class="buttons">
        <button class="btn-clear" onclick="clearSignature()">Borrar firma</button>
        <button class="btn-save" onclick="saveForm()">Guardar documento</button>
        <button class="btn-sign" onclick="signDocument()">Confirmar firma</button>
      </div>

      <div class="muted" id="statusText">Selecciona un documento antes de firmar.</div>
    </div>
  </div>
</main>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("t");

  const docsContainer = document.getElementById("docs");
  const docContainer = document.getElementById("docContainer");
  const patientBadge = document.getElementById("patientBadge");
  const currentDocName = document.getElementById("currentDocName");
  const statusText = document.getElementById("statusText");

  let currentDocIndex = null;
  let currentPatient = null;

  const canvas = document.getElementById("signaturePad");
  const signaturePad = new SignaturePad(canvas);

  function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
    signaturePad.clear();
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  function showError(msg) {
    document.body.innerHTML = `<div class="error">${msg}</div>`;
  }

  if (!token) {
    showError("‚ö†Ô∏è Link inv√°lido. Falta el token del paciente.");
  } else {
    currentPatient = PATIENTS[token];
    if (!currentPatient) showError("‚ö†Ô∏è Token no encontrado. Este link no existe o ya fue desactivado.");
    else {
      patientBadge.innerText = `Paciente: ${currentPatient.name}`;
      renderDocs();
    }
  }

  function renderDocs() {
    docsContainer.innerHTML = "";

    currentPatient.docs.forEach((doc, index) => {
      const item = document.createElement("div");
      item.className = "doc-item";
      item.onclick = () => openDoc(index);

      const status = doc.signed ? "Firmado" : "Pendiente";
      const statusClass = doc.signed ? "status signed" : "status pending";

      item.innerHTML = `<div class="title">${doc.title}</div><div class="${statusClass}">${status}</div>`;
      docsContainer.appendChild(item);
    });

    if (currentPatient.docs[0]) openDoc(0);
  }

  function openDoc(index) {
    currentDocIndex = index;
    const doc = currentPatient.docs[index];

    currentDocName.innerText = doc.title;
    signaturePad.clear();

    if (doc.type === "pdf") {
      docContainer.innerHTML = `<iframe src="${doc.url}"></iframe>`;
      statusText.innerText = doc.signed ? "‚úÖ Este documento ya fue firmado." : "‚úçÔ∏è Firma y presiona Confirmar firma.";
      toggleSaveButton(false);
      return;
    }

    if (doc.type === "form") {
      docContainer.innerHTML = renderTemplate(doc.template);
      statusText.innerText = doc.signed ? "‚úÖ Documento ya firmado." : "üìù Llena el documento, guarda y firma.";
      toggleSaveButton(true);
      loadSavedForm();
      return;
    }

    docContainer.innerHTML = `<div class="error">Tipo de documento desconocido: ${doc.type}</div>`;
    toggleSaveButton(false);
  }

  function toggleSaveButton(show) {
    document.querySelector(".btn-save").style.display = show ? "inline-block" : "none";
  }

  function clearSignature() {
    signaturePad.clear();
  }

  // --------- TEMPLATES ----------
  function renderTemplate(templateName) {
    if (templateName === "historia_clinica") return renderHistoriaClinica();
    if (templateName === "aviso_privacidad") return renderAvisoPrivacidad();
    if (templateName === "consentimiento_masto") return renderConsentimientoMasto();
    if (templateName === "consentimiento_recto") return renderConsentimientoRecto();
    return `<div class="error">Template no encontrado: ${templateName}</div>`;
  }

  // ‚úÖ AQU√ç van tus 4 renders: Historia, Aviso, Masto, Recto
  ${'__RENDERS__'}

  // ‚úÖ Guardado local (checkbox support)
  function getFormData() {
    const inputs = docContainer.querySelectorAll("input, textarea, select");
    const data = {};
    inputs.forEach(i => {
      if (!i.id) return;
      if (i.type === "checkbox") data[i.id] = i.checked ? "on" : "";
      else data[i.id] = i.value;
    });
    return data;
  }

  function loadSavedForm() {
    const doc = currentPatient.docs[currentDocIndex];
    const saved = localStorage.getItem("HC_" + token + "_" + doc.template);
    if (!saved) return;
    const data = JSON.parse(saved);
    Object.keys(data).forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      if (el.type === "checkbox") el.checked = data[id] === "on";
      else el.value = data[id];
    });
  }

  function saveForm() {
    if (currentDocIndex === null) return;
    const doc = currentPatient.docs[currentDocIndex];
    if (doc.type !== "form") return;

    const data = getFormData();
    localStorage.setItem("HC_" + token + "_" + doc.template, JSON.stringify(data));
    statusText.innerText = "‚úÖ Documento guardado (local). Ahora firma y confirma.";
  }

  // ‚úÖ Validaciones
  function validateTemplate(template, data) {

    const required = (field, label) => {
      if (!data[field] || data[field].toString().trim() === "") {
        return { ok: false, msg: `Falta completar: ${label}` };
      }
      return null;
    };

    const requiredCheck = (field, label) => {
      if (data[field] !== "on") return { ok: false, msg: `Debes marcar: ${label}` };
      return null;
    };

    if (template === "aviso_privacidad") {
      return (
        required("ap_nombre", "Nombre completo") ||
        required("ap_fecha", "Fecha") ||
        requiredCheck("ap_chk_acepto", "Aceptaci√≥n del aviso") ||
        requiredCheck("ap_chk_compartir", "Autorizaci√≥n de compartir resultados") ||
        { ok: true }
      );
    }

    if (template === "consentimiento_masto") {
      return (
        required("masto_fecha", "Fecha") ||
        required("masto_nombre", "Nombre") ||
        required("masto_fn", "Fecha nacimiento") ||
        required("masto_edad", "Edad") ||
        required("masto_dir", "Direcci√≥n") ||
        required("masto_colonia", "Colonia") ||
        required("masto_tel", "Tel√©fono") ||
        required("masto_cancer", "C√°ncer de mama (Si/No)") ||
        required("masto_meds", "Medicamento (Si/No)") ||
        required("masto_horm", "Hormonas (Si/No)") ||
        requiredCheck("masto_chk", "Confirmaci√≥n y autorizaci√≥n") ||
        { ok: true }
      );
    }

    if (template === "consentimiento_recto") {
      return (
        required("recto_fecha", "Fecha") ||
        required("recto_nombre", "Nombre") ||
        required("recto_fn", "Fecha nacimiento") ||
        required("recto_edad", "Edad") ||
        required("recto_sexo", "Sexo") ||
        requiredCheck("recto_chk", "Consentimiento") ||
        requiredCheck("recto_chk_alt", "Alternativas / urgencias") ||
        { ok: true }
      );
    }

    if (template === "historia_clinica") {
      return (
        required("hc_nombre", "Nombre completo") ||
        required("hc_fn", "Fecha de nacimiento") ||
        { ok: true }
      );
    }

    return { ok: true };
  }

  // ‚úÖ Firmar
  async function signDocument() {
    if (currentDocIndex === null) return;

    const doc = currentPatient.docs[currentDocIndex];

    if (signaturePad.isEmpty()) {
      statusText.innerText = "‚ö†Ô∏è La firma est√° vac√≠a. Firma antes de confirmar.";
      return;
    }

    let formData = null;

    if (doc.type === "form") {
      formData = getFormData();

      const valid = validateTemplate(doc.template, formData);
      if (!valid.ok) {
        statusText.innerText = "‚ö†Ô∏è " + valid.msg;
        return;
      }

      localStorage.setItem("HC_" + token + "_" + doc.template, JSON.stringify(formData));
    }

    const signature = signaturePad.toDataURL();

    try {
      await fetch(BACKEND_URL, {
        method: "POST",
        body: JSON.stringify({
          token,
          patientName: currentPatient.name,
          docTitle: doc.title,
          docType: doc.type,
          formData,
          signature,
          timestamp: new Date().toISOString()
        }),
        headers: { "Content-Type": "text/plain;charset=utf-8" }
      });

      currentPatient.docs[currentDocIndex].signed = true;
      statusText.innerText = "‚úÖ Firma registrada y enviada.";
      renderDocs();

    } catch (err) {
      console.error(err);
      statusText.innerText = "‚ö†Ô∏è Error al guardar. Revisa BACKEND_URL y permisos.";
    }
  }
</script>

</body>
</html>
