<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portal de Firmas | Cl√≠nica</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">

 <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script src="data.js"></script>
  <style>
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: #0b0f19; color: #e6e8ee; }
    header {
      padding: 18px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(255,255,255,0.02);
      backdrop-filter: blur(10px);
    }
    header h1 { margin: 0; font-size: 16px; }
    header .badge {
      padding: 8px 12px; border-radius: 999px; font-size: 12px;
      background: rgba(145, 255, 200, 0.10);
      border: 1px solid rgba(145, 255, 200, 0.25);
      color: #91ffc8;
    }

    main {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      padding: 18px;
      height: calc(100vh - 70px);
    }

    .panel {
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      background: rgba(255,255,255,0.03);
      overflow: hidden;
    }

    .doc-list { padding: 14px; }
    .doc-list h2 { margin: 0 0 10px; font-size: 14px; font-weight: 700; color: #cfd6e6; }
    .doc-item {
      padding: 12px; border-radius: 12px; margin-bottom: 10px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.02);
      transition: all .2s ease;
      display: flex; justify-content: space-between; gap: 10px; align-items: center;
    }
    .doc-item:hover { transform: translateY(-1px); border-color: rgba(255,255,255,0.18); }
    .doc-item .title { font-size: 13px; font-weight: 500; }
    .doc-item .status {
      font-size: 11px; padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      opacity: 0.9;
    }
    .signed { background: rgba(145,255,200,0.10); color: #91ffc8; border-color: rgba(145,255,200,0.28)!important; }
    .pending { background: rgba(255,210,125,0.10); color: #ffd27d; border-color: rgba(255,210,125,0.28)!important; }

    .viewer { display: grid; grid-template-rows: 1fr auto; height: 100%; }
    iframe { width: 100%; height: 100%; border: 0; background: #0a0d14; }

    .contentArea { height: 100%; overflow: auto; padding: 18px; }

    .sectionTitle {
      background: #2f5fb8;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 800;
      margin: 18px 0 12px;
      text-align: center;
      letter-spacing: 0.5px;
    }

    .formGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .field label {
      font-size: 12px;
      color: rgba(230,232,238,0.75);
      display: block;
      margin-bottom: 6px;
    }
    .field input, .field textarea, .field select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.02);
      color: #e6e8ee;
      outline: none;
      font-size: 13px;
    }
    textarea { min-height: 90px; resize: vertical; }
    .full { grid-column: 1 / -1; }

    .signature-area {
      padding: 14px;
      border-top: 1px solid rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .signature-area h3 {
      margin: 0;
      font-size: 13px;
      font-weight: 700;
      color: #cfd6e6;
      display: flex;
      justify-content: space-between;
    }

    canvas {
      width: 100%;
      height: 140px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,0.20);
      background: rgba(255,255,255,0.02);
    }

    .buttons { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
    button {
      border: 0; padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all .2s ease;
    }
    .btn-clear { background: rgba(255,255,255,0.06); color: #e6e8ee; border: 1px solid rgba(255,255,255,0.10); }
    .btn-clear:hover { background: rgba(255,255,255,0.10); }

    .btn-save { background: rgba(255,210,125,0.12); color: #ffd27d; border: 1px solid rgba(255,210,125,0.25); }
    .btn-save:hover { background: rgba(255,210,125,0.18); transform: translateY(-1px); }

    .btn-sign { background: linear-gradient(90deg, #5b7cfa, #8e5bfa); color: white; }
    .btn-sign:hover { opacity: 0.9; transform: translateY(-1px); }

    .muted { color: rgba(230,232,238,0.65); font-size: 12px; }
    .error {
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,80,80,0.12);
      border: 1px solid rgba(255,80,80,0.25);
      color: #ffb4b4;
      margin: 14px;
      font-size: 13px;
    }

    .stepNav {
      margin-top: 14px;
      display: flex;
      gap: 10px;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.02);
      font-size: 12px;
      color: rgba(230,232,238,0.75);
    }

    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; height: auto; }
      .viewer { height: 78vh; }
      .formGrid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<header>
  <h1>Portal de Firmas ‚Äî Cl√≠nica Privada</h1>
  <div class="badge" id="patientBadge">Cargando paciente‚Ä¶</div>
</header>

<main>
  <div class="panel doc-list">
    <h2>Documentos</h2>
    <div id="docs"></div>
    <p class="muted">Selecciona un documento para visualizarlo y firmarlo.</p>
  </div>

  <div class="panel viewer">
    <div id="docContainer" class="contentArea"></div>

    <div class="signature-area">
      <h3>Firma del paciente <span class="muted" id="currentDocName">‚Äî</span></h3>

      <canvas id="signaturePad"></canvas>

      <div class="buttons">
        <button class="btn-clear" onclick="clearSignature()">Borrar firma</button>
        <button class="btn-save" onclick="saveForm()">Guardar documento</button>
        <button class="btn-sign" onclick="signDocument()">Confirmar firma</button>
      </div>

      <div class="muted" id="statusText">Selecciona un documento antes de firmar.</div>
    </div>
  </div>
</main>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("t");

  const docsContainer = document.getElementById("docs");
  const docContainer = document.getElementById("docContainer");
  const patientBadge = document.getElementById("patientBadge");
  const currentDocName = document.getElementById("currentDocName");
  const statusText = document.getElementById("statusText");

  let currentDocIndex = null;
  let currentPatient = null;

  const canvas = document.getElementById("signaturePad");
  const signaturePad = new SignaturePad(canvas);

  function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
    signaturePad.clear();
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  function showError(msg) {
    document.body.innerHTML = `<div class="error">${msg}</div>`;
  }

  if (!token) {
    showError("‚ö†Ô∏è Link inv√°lido. Falta el token del paciente.");
  } else {
    currentPatient = PATIENTS[token];
    if (!currentPatient) showError("‚ö†Ô∏è Token no encontrado. Este link no existe o ya fue desactivado.");
    else {
      patientBadge.innerText = `Paciente: ${currentPatient.name}`;
      renderDocs();
    }
  }

  function renderDocs() {
    docsContainer.innerHTML = "";

    currentPatient.docs.forEach((doc, index) => {
      const item = document.createElement("div");
      item.className = "doc-item";
      item.onclick = () => openDoc(index);

      const status = doc.signed ? "Firmado" : "Pendiente";
      const statusClass = doc.signed ? "status signed" : "status pending";

      item.innerHTML = `<div class="title">${doc.title}</div><div class="${statusClass}">${status}</div>`;
      docsContainer.appendChild(item);
    });

    if (currentPatient.docs[0]) openDoc(0);
  }

  function openDoc(index) {
    currentDocIndex = index;
    const doc = currentPatient.docs[index];

    currentDocName.innerText = doc.title;
    signaturePad.clear();

    if (doc.type === "pdf") {
      docContainer.innerHTML = `<iframe src="${doc.url}"></iframe>`;
      statusText.innerText = doc.signed ? "‚úÖ Este documento ya fue firmado." : "‚úçÔ∏è Firma y presiona Confirmar firma.";
      toggleSaveButton(false);
      return;
    }

    if (doc.type === "form") {
      docContainer.innerHTML = renderTemplate(doc.template);
      statusText.innerText = doc.signed ? "‚úÖ Documento ya firmado." : "üìù Llena el documento, guarda y firma.";
      toggleSaveButton(true);
      loadSavedForm();
      return;
    }

    docContainer.innerHTML = `<div class="error">Tipo de documento desconocido: ${doc.type}</div>`;
    toggleSaveButton(false);
  }

  function toggleSaveButton(show) {
    document.querySelector(".btn-save").style.display = show ? "inline-block" : "none";
  }

  function clearSignature() {
    signaturePad.clear();
  }

  // --------- TEMPLATES ----------
  function renderTemplate(templateName) {
    if (templateName === "historia_clinica") return renderHistoriaClinica();
    if (templateName === "aviso_privacidad") return renderAvisoPrivacidad();
    if (templateName === "consentimiento_masto") return renderConsentimientoMasto();
    if (templateName === "consentimiento_recto") return renderConsentimientoRecto();
    return `<div class="error">Template no encontrado: ${templateName}</div>`;
  }

  // ‚úÖ 1) AVISO PRIVACIDAD
  function renderAvisoPrivacidad() {
    return `
      <div class="sectionTitle">AVISO DE PRIVACIDAD</div>
      <div class="muted" style="line-height:1.65;">
        En t√©rminos de lo previsto en la Ley Federal de Protecci√≥n de Datos Personales en Posesi√≥n de los Particulares...
        (Texto completo aqu√≠, como ya lo tienes)
      </div>

      <div class="sectionTitle">AUTORIZACI√ìN</div>
      <div class="muted" style="font-weight:700; text-align:center; line-height:1.6;">
        AUTORIZO QUE LOS RESULTADOS DE MIS EX√ÅMENES M√âDICOS SEAN COMPARTIDOS CON EL GRUPO DE M√âDICOS QUE SE ENCUENTRAN EN MI REVISI√ìN.
      </div>

      <div class="formGrid" style="margin-top:14px;">
        <div class="field full">
          <label>Nombre completo del paciente*</label>
          <input id="ap_nombre" />
        </div>
        <div class="field">
          <label>Fecha*</label>
          <input id="ap_fecha" type="date" />
        </div>
        <div class="field full">
          <label><input id="ap_chk_acepto" type="checkbox" /> He le√≠do y acepto el Aviso de Privacidad.*</label>
        </div>
        <div class="field full">
          <label><input id="ap_chk_compartir" type="checkbox" /> Autorizo compartir resultados con el grupo m√©dico.*</label>
        </div>
      </div>
      <div class="muted" style="margin-top:12px;">‚úÖ Completa los campos, marca las casillas y luego firma abajo.</div>
    `;
  }

  // ‚úÖ 2) MASTOGRAF√çA
  function renderConsentimientoMasto() {
    return `
      <div class="sectionTitle">CHECK UP</div>
      <div class="sectionTitle">CONSENTIMIENTO INFORMADO PARA ESTUDIO DE MASTOGRAF√çA</div>

      <div class="formGrid">
        <div class="field"><label>Fecha*</label><input id="masto_fecha" type="date"/></div>
        <div class="field full"><label>Nombre*</label><input id="masto_nombre"/></div>
        <div class="field"><label>Fecha de nacimiento*</label><input id="masto_fn" type="date"/></div>
        <div class="field"><label>Edad*</label><input id="masto_edad" type="number"/></div>
        <div class="field full"><label>Direcci√≥n*</label><input id="masto_dir"/></div>
        <div class="field"><label>Colonia*</label><input id="masto_colonia"/></div>
        <div class="field"><label>Tel√©fono*</label><input id="masto_tel"/></div>
        <div class="field full"><label>M√©dico (se llena en cl√≠nica)</label><input id="masto_medico" disabled value="(Se llena en cl√≠nica)"/></div>
      </div>

      <div class="sectionTitle">ANTECEDENTES</div>
      <div class="formGrid">
        <div class="field">
          <label>¬øC√°ncer de mama en familia?*</label>
          <select id="masto_cancer"><option value="">Selecciona</option><option>Si</option><option>No</option></select>
        </div>
        <div class="field"><label>¬øQui√©n?</label><input id="masto_quien"/></div>

        <div class="field"><label>Medicamento*</label>
          <select id="masto_meds"><option value="">Selecciona</option><option>Si</option><option>No</option></select>
        </div>
        <div class="field"><label>Hormonas*</label>
          <select id="masto_horm"><option value="">Selecciona</option><option>Si</option><option>No</option></select>
        </div>

        <div class="field full">
          <label><input id="masto_chk" type="checkbox"/> Confirmo informaci√≥n y autorizo el estudio.*</label>
        </div>
      </div>

      <div class="muted" style="margin-top:12px;">‚úÖ Completa y firma abajo.</div>
    `;
  }

  // ‚úÖ 3) RECTO
  function renderConsentimientoRecto() {
    return `
      <div class="sectionTitle">CHECK UP</div>
      <div class="sectionTitle">CONSENTIMIENTO INFORMADO PARA ESTUDIO DE RECTOSIGMOIDOSCOP√çA</div>

      <div class="muted" style="line-height:1.65;">
        Documento informativo (texto completo, como ya lo tienes)...
      </div>

      <div class="sectionTitle">DATOS DEL PACIENTE</div>
      <div class="formGrid">
        <div class="field"><label>Fecha*</label><input id="recto_fecha" type="date"/></div>
        <div class="field full"><label>Nombre completo*</label><input id="recto_nombre"/></div>
        <div class="field"><label>Fecha nacimiento*</label><input id="recto_fn" type="date"/></div>
        <div class="field"><label>Edad*</label><input id="recto_edad" type="number"/></div>
        <div class="field"><label>Sexo*</label><input id="recto_sexo"/></div>

        <div class="field full"><label>M√©dico (se llena en cl√≠nica)</label><input id="recto_dr" disabled value="(Se llena en cl√≠nica)"/></div>

        <div class="field full">
          <label><input id="recto_chk" type="checkbox"/> Confirmo consentimiento libre y voluntario.*</label>
        </div>
        <div class="field full">
          <label><input id="recto_chk_alt" type="checkbox"/> Entiendo alternativas y urgencias.*</label>
        </div>
      </div>

      <div class="muted" style="margin-top:12px;">‚úÖ Completa y firma abajo.</div>
    `;
  }

  // ‚úÖ 4) HISTORIA CL√çNICA (por secciones)
  let hcStep = 0;

  function renderHistoriaClinica() {
    return `
      <div class="sectionTitle">HISTORIA CL√çNICA CHECK UP</div>
      <div class="pill">Secci√≥n ${hcStep + 1} de 5</div>
      ${renderHCStep(hcStep)}
      <div class="stepNav">
        <button class="btn-clear" onclick="prevHC()">Anterior</button>
        <button class="btn-save" onclick="saveForm()">Guardar secci√≥n</button>
        <button class="btn-sign" onclick="nextHC()">Siguiente</button>
      </div>
      <div class="muted" style="margin-top:12px;">
        ‚úÖ Al terminar todas las secciones, guarda y firma abajo.
      </div>
    `;
  }

  function renderHCStep(step) {
    if (step === 0) return `
      <div class="sectionTitle">DATOS GENERALES</div>
      <div class="formGrid">
        <div class="field full"><label>Nombre completo*</label><input id="hc_nombre"/></div>
        <div class="field"><label>Fecha de nacimiento*</label><input id="hc_fn" type="date"/></div>
        <div class="field"><label>Edad*</label><input id="hc_edad" type="number"/></div>
        <div class="field"><label>Tel√©fono*</label><input id="hc_tel"/></div>
        <div class="field full"><label>Correo*</label><input id="hc_correo" type="email"/></div>
        <div class="field full"><label>Domicilio*</label><input id="hc_dom"/></div>
      </div>
    `;

    if (step === 1) return `
      <div class="sectionTitle">ANTECEDENTES HEREDO FAMILIARES</div>
      <div class="formGrid">
        <div class="field"><label>C√°ncer (SI/NO)</label><select id="hf_cancer"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field"><label>¬øQui√©n?</label><input id="hf_cancer_quien"/></div>
        <div class="field"><label>Diabetes (SI/NO)</label><select id="hf_dm"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field"><label>¬øQui√©n?</label><input id="hf_dm_quien"/></div>
      </div>
    `;

    if (step === 2) return `
      <div class="sectionTitle">EXPLORACI√ìN F√çSICA (CL√çNICA)</div>
      <div class="muted" style="text-align:center;font-weight:700;">*Se llena en cl√≠nica*</div>
      <div class="formGrid">
        <div class="field"><label>Presi√≥n arterial</label><input id="ef_pa"/></div>
        <div class="field"><label>Frecuencia card√≠aca</label><input id="ef_fc"/></div>
        <div class="field"><label>Peso (kg)</label><input id="ef_peso"/></div>
        <div class="field"><label>Talla (m)</label><input id="ef_talla"/></div>
      </div>
    `;

    if (step === 3) return `
      <div class="sectionTitle">APARATOS Y SISTEMAS</div>
      <div class="formGrid">
        <div class="field"><label>S√≠ntomas generales</label><select id="as_sg"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field full"><label>Descripci√≥n</label><textarea id="as_sg_desc"></textarea></div>
        <div class="field full"><label>Medicamentos (dosis y desde cu√°ndo)</label><textarea id="as_meds"></textarea></div>
      </div>
    `;

    return `
      <div class="sectionTitle">HOSPITALIZACIONES</div>
      <div class="formGrid">
        <div class="field"><label>Hospitalizaciones (SI/NO)</label><select id="hos_si"><option value="">Selecciona</option><option>SI</option><option>NO</option></select></div>
        <div class="field full"><label>Motivos</label><textarea id="hos_motivos"></textarea></div>
        <div class="field full"><label>Eventos quir√∫rgicos</label><textarea id="hos_qx"></textarea></div>
      </div>

      <div class="sectionTitle">DECLARACI√ìN FINAL</div>
      <div class="field full">
        <label><input id="hc_declaro" type="checkbox"/> Declaro que la informaci√≥n otorgada es ver√≠dica y completa.*</label>
      </div>
    `;
  }

  function nextHC() {
    saveForm();
    if (hcStep < 4) hcStep++;
    docContainer.innerHTML = renderHistoriaClinica();
    loadSavedForm();
  }

  function prevHC() {
    saveForm();
    if (hcStep > 0) hcStep--;
    docContainer.innerHTML = renderHistoriaClinica();
    loadSavedForm();
  }

  // ‚úÖ Guardado local (incluye checkboxes)
  function getFormData() {
    const inputs = docContainer.querySelectorAll("input, textarea, select");
    const data = {};
    inputs.forEach(i => {
      if (!i.id) return;
      if (i.type === "checkbox") data[i.id] = i.checked ? "on" : "";
      else data[i.id] = i.value;
    });
    return data;
  }

  function loadSavedForm() {
    const doc = currentPatient.docs[currentDocIndex];
    const saved = localStorage.getItem("HC_" + token + "_" + doc.template);
    if (!saved) return;
    const data = JSON.parse(saved);
    Object.keys(data).forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      if (el.type === "checkbox") el.checked = data[id] === "on";
      else el.value = data[id];
    });
  }

  function saveForm() {
    if (currentDocIndex === null) return;
    const doc = currentPatient.docs[currentDocIndex];
    if (doc.type !== "form") return;

    const data = getFormData();
    localStorage.setItem("HC_" + token + "_" + doc.template, JSON.stringify(data));
    statusText.innerText = "‚úÖ Documento guardado (local). Ahora firma y confirma.";
  }

  // ‚úÖ Validaciones
  function validateTemplate(template, data) {
    const required = (field, label) => (!data[field] || data[field].trim() === "") ? { ok:false, msg:`Falta completar: ${label}` } : null;
    const requiredCheck = (field, label) => data[field] !== "on" ? { ok:false, msg:`Debes marcar: ${label}` } : null;

    if (template === "aviso_privacidad") {
      return required("ap_nombre","Nombre") || required("ap_fecha","Fecha") ||
        requiredCheck("ap_chk_acepto","Aceptaci√≥n") || requiredCheck("ap_chk_compartir","Autorizaci√≥n") || { ok:true };
    }

    if (template === "consentimiento_masto") {
      return required("masto_fecha","Fecha") || required("masto_nombre","Nombre") ||
        required("masto_fn","Nacimiento") || required("masto_edad","Edad") ||
        required("masto_dir","Direcci√≥n") || required("masto_colonia","Colonia") ||
        required("masto_tel","Tel√©fono") || required("masto_cancer","C√°ncer familiar") ||
        required("masto_meds","Medicamento") || required("masto_horm","Hormonas") ||
        requiredCheck("masto_chk","Confirmaci√≥n") || { ok:true };
    }

    if (template === "consentimiento_recto") {
      return required("recto_fecha","Fecha") || required("recto_nombre","Nombre") ||
        required("recto_fn","Nacimiento") || required("recto_edad","Edad") ||
        required("recto_sexo","Sexo") || requiredCheck("recto_chk","Consentimiento") ||
        requiredCheck("recto_chk_alt","Alternativas") || { ok:true };
    }

    if (template === "historia_clinica") {
      return required("hc_nombre","Nombre") || required("hc_fn","Nacimiento") ||
        requiredCheck("hc_declaro","Declaraci√≥n final") || { ok:true };
    }

    return { ok:true };
  }

  // ‚úÖ Firmar
  async function signDocument() {
    if (currentDocIndex === null) return;

    const doc = currentPatient.docs[currentDocIndex];

    if (signaturePad.isEmpty()) {
      statusText.innerText = "‚ö†Ô∏è La firma est√° vac√≠a. Firma antes de confirmar.";
      return;
    }

    let formData = null;

    if (doc.type === "form") {
      formData = getFormData();
      const valid = validateTemplate(doc.template, formData);
      if (!valid.ok) { statusText.innerText = "‚ö†Ô∏è " + valid.msg; return; }
      localStorage.setItem("HC_" + token + "_" + doc.template, JSON.stringify(formData));
    }

    const signature = signaturePad.toDataURL();

    try {
      await fetch(BACKEND_URL, {
        method: "POST",
        body: JSON.stringify({
          token,
          patientName: currentPatient.name,
          docTitle: doc.title,
          docType: doc.type,
          formData,
          signature,
          timestamp: new Date().toISOString()
        }),
        headers: { "Content-Type": "text/plain;charset=utf-8" }
      });

      currentPatient.docs[currentDocIndex].signed = true;
      statusText.innerText = "‚úÖ Firma registrada y enviada.";
      renderDocs();

    } catch (err) {
      console.error(err);
      statusText.innerText = "‚ö†Ô∏è Error al guardar. Revisa BACKEND_URL y permisos.";
    }
  }
</script>

</body>
</html>
